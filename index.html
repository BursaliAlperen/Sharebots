<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Bot Görevleri</title>
<style>
  body {
    font-family: sans-serif;
    background: #121212;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }
  h1 {
    margin-top: 30px;
  }
  .points {
    font-size: 24px;
    margin: 10px 0;
  }
  button {
    padding: 10px 20px;
    margin: 10px;
    font-size: 18px;
    background-color: #2a9d8f;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:disabled {
    background-color: gray;
    cursor: not-allowed;
  }
  #toast {
    position: fixed;
    bottom: 20px;
    background: #333;
    padding: 10px 20px;
    border-radius: 6px;
    display: none;
  }
  #visitTaskCard {
    margin-top: 20px;
    padding: 10px;
    border: 1px solid #2a9d8f;
    border-radius: 6px;
    display: none;
    width: 300px;
    text-align: center;
  }
  #earnPointsCard {
    margin-top: 20px;
  }
  a {
    color: #1db954;
  }
  .langButtons {
    margin-top: 20px;
  }
  .langButtons button {
    background: #264653;
  }
</style>
</head>
<body>
<h1 id="title">Bot Görevleri</h1>

<div class="points">Puan: <span id="pointDisplay">0</span></div>

<div id="earnPointsCard">
  <button id="watchAdBtn">Reklam İzle (+10)</button>
  <button id="visitBotBtn">Botu Ziyaret Et (+10)</button>
</div>

<div id="visitTaskCard">
  <p id="visitTaskText">Lütfen şu botu ziyaret edin:</p>
  <a id="visitBotLink" href="#" target="_blank" rel="noopener noreferrer">Botu Aç</a>
  <p>Kalan süre: <span id="timer">5</span> saniye</p>
</div>

<div class="langButtons">
  <button id="langTrBtn">Türkçe</button>
  <button id="langEnBtn">English</button>
</div>

<div id="toast"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- VERİLER VE DURUMLAR ---
  const translations = {
    tr: {
      title: "Bot Görevleri",
      pointLabel: "Puan: ",
      watchAdBtn: "Reklam İzle (+10)",
      adLoading: "Reklam yükleniyor...",
      adWatchedSuccess: "10 puan kazandınız!",
      adError: "Reklam yüklenemedi.",
      visitBotBtn: "Botu Ziyaret Et (+10)",
      noBotsToVisit: "Ziyaret edilecek uygun bot yok!",
      visitTaskCompleted: "Ziyaret tamamlandı, 10 puan kazandınız!",
      visitTaskCancelled: "Ziyaret iptal edildi.",
      visitTaskText: "Lütfen şu botu ziyaret edin:",
    },
    en: {
      title: "Bot Tasks",
      pointLabel: "Points: ",
      watchAdBtn: "Watch Ad (+10)",
      adLoading: "Loading ad...",
      adWatchedSuccess: "You earned 10 points!",
      adError: "Failed to load ad.",
      visitBotBtn: "Visit Bot (+10)",
      noBotsToVisit: "No eligible bots to visit!",
      visitTaskCompleted: "Visit completed, you earned 10 points!",
      visitTaskCancelled: "Visit cancelled.",
      visitTaskText: "Please visit this bot:",
    }
  };

  let currentLanguage = localStorage.getItem("language") || "tr";

  const appData = {
    users: {
      user1: { points: 50 },
      user2: { points: 15 },
      user3: { points: 5 },
      // Buraya başka kullanıcılar da eklenebilir
    },
    botLinks: [
      { owner: "user1", url: "https://t.me/somebot1" },
      { owner: "user2", url: "https://t.me/somebot2" },
      { owner: "user3", url: "https://t.me/somebot3" },
    ],
  };

  const currentUser = { id: "user0", points: 0 };

  // --- ELEMENTLER ---
  const pointDisplay = document.getElementById("pointDisplay");
  const watchAdBtn = document.getElementById("watchAdBtn");
  const visitBotBtn = document.getElementById("visitBotBtn");
  const toast = document.getElementById("toast");
  const visitTaskCard = document.getElementById("visitTaskCard");
  const earnPointsCard = document.getElementById("earnPointsCard");
  const visitBotLinkEl = document.getElementById("visitBotLink");
  const timerEl = document.getElementById("timer");
  const titleEl = document.getElementById("title");
  const langTrBtn = document.getElementById("langTrBtn");
  const langEnBtn = document.getElementById("langEnBtn");
  const visitTaskTextEl = document.getElementById("visitTaskText");

  // --- DURUM ---
  let points = 0;
  let visitTask = {
    chosenBot: null,
    timeLeft: 0,
    timerId: null,
    visibilityListener: null,
  };

  // --- FONKSİYONLAR ---

  function showToast(message, type = "info") {
    toast.textContent = message;
    toast.style.background = (type === "error") ? "#b00020" : "#333";
    toast.style.display = "block";
    setTimeout(() => { toast.style.display = "none"; }, 2500);
  }

  function changePoints(delta) {
    points += delta;
    if(points < 0) points = 0;
    currentUser.points = points;
    pointDisplay.textContent = points;
  }

  function saveState() {
    localStorage.setItem("points", points);
    localStorage.setItem("language", currentLanguage);
    localStorage.setItem("users", JSON.stringify(appData.users));
  }

  function loadState() {
    points = parseInt(localStorage.getItem("points")) || 0;
    currentUser.points = points;
    pointDisplay.textContent = points;
    currentLanguage = localStorage.getItem("language") || "tr";

    const usersData = localStorage.getItem("users");
    if(usersData){
      try {
        const parsed = JSON.parse(usersData);
        for(const key in parsed){
          if(appData.users[key]){
            appData.users[key].points = parsed[key].points;
          }
        }
      } catch(e){
        console.error("Kullanıcı verisi yüklenemedi:", e);
      }
    }
  }

  function setLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem("language", lang);
    const T = translations[lang];

    titleEl.textContent = T.title;
    watchAdBtn.textContent = T.watchAdBtn;
    visitBotBtn.textContent = T.visitBotBtn;
    visitTaskTextEl.textContent = T.visitTaskText;
    document.querySelector(".points").innerHTML = T.pointLabel + `<span id="pointDisplay">${points}</span>`;
  }

  // --- İŞLEMLER ---

  const handleWatchAd = async () => {
    const T = translations[currentLanguage];
    try {
      watchAdBtn.disabled = true;
      watchAdBtn.textContent = T.adLoading;

      if(typeof window.show9448585 !== "function"){
        await new Promise(r => setTimeout(r, 3000));
      } else {
        await window.show9448585();
      }

      changePoints(10);
      showToast(T.adWatchedSuccess);
    } catch (e) {
      console.error(e);
      showToast(T.adError, "error");
    } finally {
      watchAdBtn.textContent = T.watchAdBtn;
      watchAdBtn.disabled = false;
      saveState();
    }
  };

  const handleVisitBot = () => {
    const T = translations[currentLanguage];
    const eligibleBots = appData.botLinks.filter(bot =>
      bot.owner !== currentUser.id &&
      appData.users[bot.owner] &&
      appData.users[bot.owner].points >= 10
    );

    if(eligibleBots.length === 0){
      showToast(T.noBotsToVisit, "error");
      return;
    }

    const chosen = eligibleBots[Math.floor(Math.random() * eligibleBots.length)];

    // Bot sahibi puanını 10 eksilt
    appData.users[chosen.owner].points -= 10;
    if(appData.users[chosen.owner].points < 0) appData.users[chosen.owner].points = 0;

    // Giren kullanıcıya 10 puan ekle
    changePoints(10);

    saveState();

    visitTask.chosenBot = chosen;
    visitTask.timeLeft = 5;

    visitBotLinkEl.href = chosen.url;
    timerEl.textContent = "5";
    visitTaskCard.style.display = "block";
    earnPointsCard.style.display = "none";

    visitTask.timerId = setInterval(() => {
      visitTask.timeLeft--;
      timerEl.textContent = visitTask.timeLeft.toString();

      if(visitTask.timeLeft <= 0){
        clearInterval(visitTask.timerId);
        visitTaskCard.style.display = "none";
        earnPointsCard.style.display = "block";
        showToast(T.visitTaskCompleted);
        saveState();
        document.removeEventListener("visibilitychange", visitTask.visibilityListener);
      }
    }, 1000);

    visitTask.visibilityListener = () => {
      if(document.hidden){
        clearInterval(visitTask.timerId);
        visitTaskCard.style.display = "none";
        earnPointsCard.style.display = "block";
        showToast(T.visitTaskCancelled, "error");
        document.removeEventListener("visibilitychange", visitTask.visibilityListener);
      }
    };

    document.addEventListener("visibilitychange", visitTask.visibilityListener);
  };

  // Dil butonları
  langTrBtn.addEventListener("click", () => {
    setLanguage("tr");
  });
  langEnBtn.addEventListener("click", () => {
    setLanguage("en");
  });

  watchAdBtn.addEventListener("click", handleWatchAd);
  visitBotBtn.addEventListener("click", handleVisitBot);

  loadState();
  setLanguage(currentLanguage);
});
</script>
</body>
</html>
