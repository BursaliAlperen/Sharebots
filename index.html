<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Önceki head içeriği aynen kalıyor -->
    <!-- ... -->
</head>
<body>
    <!-- Önceki HTML yapısı aynen kalıyor -->
    <!-- ... -->

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Önceki tanımlamalar aynen kalıyor
            // ...

            // TÜM BUTON FONKSİYONLARINI YENİDEN YAZIYORUZ
            // =============================================

            // REKLAM İZLE BUTONU
            watchAdBtn.addEventListener('click', async function() {
                const T = translations[currentLanguage];
                if (currentUser.points < 0) { // Basit bir kontrol
                    showToast(T.notEnoughPointsError, 'error');
                    return;
                }

                showLoader();
                try {
                    // Reklam simülasyonu (3 saniye)
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Puan ekleme
                    currentUser.points += 10;
                    appData.users[currentUser.id].points = currentUser.points;
                    
                    // Kaydet
                    const success = await saveRemoteState(appData);
                    if (success) {
                        showToast(T.adWatchedSuccess, 'success');
                        updateUI();
                    }
                } catch (error) {
                    console.error('Reklam hatası:', error);
                    showToast(T.adError, 'error');
                } finally {
                    hideLoader();
                }
            });

            // BOT ZİYARET ET BUTONU
            visitBotBtn.addEventListener('click', async function() {
                const T = translations[currentLanguage];
                
                // Uygun botları filtrele
                const eligibleBots = appData.botLinks.filter(bot => 
                    bot.owner !== currentUser.id && 
                    appData.users[bot.owner]?.points >= 10);
                
                if (eligibleBots.length === 0) {
                    showToast(T.noBotsToVisit, 'error');
                    return;
                }

                // Rastgele bot seç
                const randomBot = eligibleBots[Math.floor(Math.random() * eligibleBots.length)];
                
                // Görevi başlat
                visitTask = {
                    active: true,
                    startTime: Date.now(),
                    chosenBot: randomBot
                };

                // UI güncelle
                visitBotLinkEl.href = randomBot.link;
                visitBotLinkEl.textContent = randomBot.link;
                earnPointsCard.style.display = 'none';
                visitTaskCard.style.display = 'block';

                // Geri sayım
                let secondsLeft = 5;
                timerEl.textContent = secondsLeft;
                
                const countdown = setInterval(() => {
                    secondsLeft--;
                    timerEl.textContent = secondsLeft;
                    
                    if (secondsLeft <= 0 || !visitTask.active) {
                        clearInterval(countdown);
                    }
                }, 1000);
            });

            // BOT EKLE BUTONU
            addBotBtn.addEventListener('click', async function() {
                const botLink = addBotInput.value.trim();
                const T = translations[currentLanguage];
                
                // Validasyon
                if (!botLink.startsWith('https://t.me/')) {
                    showToast(T.invalidBotLink, 'error');
                    return;
                }

                if (currentUser.points < 10) {
                    showToast(T.notEnoughPointsError, 'error');
                    return;
                }

                showLoader();
                try {
                    // Bot kontrolü
                    const botExists = appData.botLinks.some(bot => 
                        bot.link === botLink && bot.owner === currentUser.id);
                    
                    if (botExists) {
                        showToast('Bu bot zaten eklenmiş!', 'error');
                        return;
                    }

                    // Yeni bot ekle
                    appData.botLinks.push({
                        link: botLink,
                        owner: currentUser.id
                    });

                    // Puan düşür
                    currentUser.points -= 10;
                    appData.users[currentUser.id].points = currentUser.points;

                    // Kaydet
                    const success = await saveRemoteState(appData);
                    if (success) {
                        showToast(T.botAddedSuccess, 'success');
                        addBotInput.value = '';
                        updateUI();
                    }
                } catch (error) {
                    console.error('Bot ekleme hatası:', error);
                    showToast(T.syncError, 'error');
                } finally {
                    hideLoader();
                }
            });

            // YENİLE BUTONU
            refreshBtn.addEventListener('click', async function() {
                showLoader();
                try {
                    appData = await fetchRemoteState();
                    const T = translations[currentLanguage];
                    showToast(T.dataRefreshed, 'success');
                    updateUI();
                } catch (error) {
                    console.error('Yenileme hatası:', error);
                    const T = translations[currentLanguage];
                    showToast(T.syncError, 'error');
                } finally {
                    hideLoader();
                }
            });

            // İPTAL BUTONU
            cancelVisitBtn.addEventListener('click', function() {
                visitTask.active = false;
                earnPointsCard.style.display = 'block';
                visitTaskCard.style.display = 'none';
            });

            // DİL DEĞİŞTİRME BUTONLARI
            langTrBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setLanguage('tr');
            });

            langEnBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setLanguage('en');
            });

            // PENCERE ODAK DEĞİŞİMİ (Bot ziyareti kontrolü)
            window.addEventListener('focus', async () => {
                if (!visitTask.active || !visitTask.startTime) return;
                
                const T = translations[currentLanguage];
                const timeSpent = (Date.now() - visitTask.startTime) / 1000;
                
                if (timeSpent < 5) {
                    showToast(T.visitTaskFail, 'error');
                    return;
                }

                showLoader();
                try {
                    // Puan ekle
                    currentUser.points += 10;
                    appData.users[currentUser.id].points = currentUser.points;
                    
                    // Bot sahibinden puan düşür
                    if (appData.users[visitTask.chosenBot.owner]?.points >= 10) {
                        appData.users[visitTask.chosenBot.owner].points -= 10;
                    }

                    const success = await saveRemoteState(appData);
                    if (success) {
                        showToast(T.visitTaskCompleted, 'success');
                        updateUI();
                    }
                } catch (error) {
                    console.error('Görev tamamlama hatası:', error);
                    showToast(T.adErrorDuringVisit, 'error');
                } finally {
                    hideLoader();
                    visitTask.active = false;
                    earnPointsCard.style.display = 'block';
                    visitTaskCard.style.display = 'none';
                }
            });

            // UYGULAMA BAŞLATMA
            const initApp = async () => {
                showLoader();
                try {
                    appData = await fetchRemoteState();
                    
                    if (tg.initDataUnsafe?.user) {
                        const tgUser = tg.initDataUnsafe.user;
                        currentUser = {
                            id: tgUser.id.toString(),
                            username: tgUser.username || `User${tgUser.id}`,
                            points: appData.users[tgUser.id]?.points || 0
                        };
                        
                        if (!appData.users[currentUser.id]) {
                            appData.users[currentUser.id] = { points: currentUser.points };
                            await saveRemoteState(appData);
                        }
                    }
                    
                    updateUI();
                } catch (error) {
                    console.error('Başlatma hatası:', error);
                    const T = translations[currentLanguage];
                    showToast(`${T.syncError}: ${error.message}`, 'error');
                } finally {
                    hideLoader();
                }
            };

            // UYGULAMAYI BAŞLAT
            initApp();

            // EKSTRA ÖZELLİK: BOT LİNKİ KOPYALAMA
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('copy-btn')) {
                    const botLink = e.target.parentElement.querySelector('div').textContent;
                    navigator.clipboard.writeText(botLink);
                    const T = translations[currentLanguage];
                    showToast(T.copied, 'success');
                }
            });
        });
    </script>
</body>
</html>
